<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NashShield | Risk, Randomness & Nash Equilibrium</title>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #0f172a;
            --accent: #38bdf8;
            --glass: rgba(255,255,255,0.08);
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            min-height: 100vh;
            color: #f8fafc;
            background: radial-gradient(circle at top, #1e293b, #020617);
            overflow-x: hidden;
        }

        canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: auto;
            padding: 40px 20px 80px;
        }

       header {
    position: relative;  /* AJOUTEZ CETTE LIGNE */
    text-align: center;
    margin-bottom: 50px;
    padding-top: 60px;  /* AJOUTEZ CETTE LIGNE pour donner de l'espace au bouton */
}

        header h1 {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        header p {
            color: #cbd5f5;
            max-width: 750px;
            margin: 12px auto 0;
            line-height: 1.7;
        }

        blockquote {
            margin: 25px auto 0;
            font-style: italic;
            color: #a5f3fc;
            max-width: 700px;
            opacity: 0.9;
        }

        .card {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(12px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.35);
        }

        .card h2 {
            margin-top: 0;
            color: var(--accent);
        }

        .slider-group {
            margin-bottom: 25px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .slider-hint {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        input[type="range"] {
            width: 100%;
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(15,23,42,0.6);
            color: #f8fafc;
            font-size: 1rem;
        }

        button {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #38bdf8, #2563eb);
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(56,189,248,0.35);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-box {
            background: rgba(15,23,42,0.6);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .result-box span {
            font-size: 1.8rem;
            font-weight: 700;
            color: #38bdf8;
        }

        .result-box small {
            display: block;
            font-size: 0.9rem;
            color: #94a3b8;
            margin-top: 8px;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #fca5a5;
        }

        .info-box {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        footer {
            text-align: center;
            opacity: 0.6;
            margin-top: 60px;
            font-size: 0.9rem;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15,23,42,0.95);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .navbar h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--accent);
            font-weight: 700;
        }

        .navbar button {
            width: auto;
            padding: 10px 20px;
            background: rgba(56,189,248,0.2);
            border: 1px solid rgba(56,189,248,0.3);
            color: #38bdf8;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .navbar button:hover {
            background: rgba(56,189,248,0.3);
            border-color: rgba(56,189,248,0.5);
            transform: translateY(-1px);
        }

        .container {
            margin-top: 70px;
        }
    </style>
</head>

<body>

<canvas id="particles"></canvas>

<div class="container">

   <header>
    <button onclick="goToWelcome()" style="position: absolute; top: 10px; left: 10px; padding: 6px 12px; background: rgba(56,189,248,0.2); border: 1px solid rgba(56,189,248,0.3); color: #38bdf8; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; width: auto; z-index: 10;">
        ‚Üê Back
    </button>
    
    <h1 style="margin: 0;">NashShield</h1>
    
    <p>
        An interactive platform for risk sharing analysis combining
        <b>Brownian motion</b>, <b>Monte Carlo simulation</b> and
        <b>Nash equilibrium</b> within insurance and reinsurance frameworks.
    </p>

    <blockquote>
        "Randomness is not chaos ‚Äî it is structure waiting to be understood."
    </blockquote>
</header>

    <!-- INTRODUCTION -->
    <div class="card">
        <h2>üìñ How It Works</h2>
        <div class="info-box">
            <p><strong>Real Quota-Share Reinsurance Formula:</strong></p>
            <ul style="color: #cbd5f5; line-height: 1.8;">
                <li><strong>Q</strong> = Ceded Quota (percentage ceded to reinsurer) ‚Üí e.g., 70%</li>
                <li><strong>Retention</strong> = 1 - Q (percentage kept by primary insurer) ‚Üí e.g., 30%</li>
                <li><strong>Ceded Premium:</strong> Pc = Q √ó P (premium transferred to reinsurer)</li>
                <li><strong>Ceded Claims:</strong> Cc = Q √ó C (claims transferred to reinsurer)</li>
                <li><strong>Profit Formula:</strong> Profit = Retention √ó (Premium - Claims) = (1-Q) √ó (P - C)</li>
            </ul>
            
            <p><strong>Classic Scenario:</strong> Players use the retention rates you set via the sliders. Profits are calculated based on these fixed choices using the real formula.</p>
            
            <p><strong>Nash Equilibrium:</strong> The system finds an optimal distribution of retention rates where no player can improve their profit by unilaterally changing their strategy.</p>
            
            <p><strong>Constraint:</strong> The sum of all retention rates must be ‚â§ 1.0 to ensure valid risk distribution.</p>
        </div>
    </div>

    <!-- CLAIM PARAMETERS -->
    <div class="card">
        <h2>üí∞ Initial Premiums by Insurer (Million Dollars)</h2>

        <blockquote>
            "The initial premium size determines exposure magnitude for each player."
        </blockquote>

        <p style="color: #cbd5f5; margin-bottom: 20px;">
            <strong>‚ö†Ô∏è All values are in MILLION DOLLARS</strong> | Example: 1000 = $1,000 Million = $1 Billion
        </p>

        <div class="slider-group">
            <label>Player A Premium (S‚ÇÄ) <span id="valS0A">1000</span> Million $</label>
            <input type="range" id="S0A" min="100" max="5000" step="100" value="1000">
            <div class="slider-hint">Initial premium in Million $ | Min: $100M | Max: $5000M</div>
        </div>

        <div class="slider-group">
            <label>Player B Premium (S‚ÇÄ) <span id="valS0B">1000</span> Million $</label>
            <input type="range" id="S0B" min="100" max="5000" step="100" value="1000">
            <div class="slider-hint">Initial premium in Million $ | Min: $100M | Max: $5000M</div>
        </div>

        <div class="slider-group">
            <label>Player C Premium (S‚ÇÄ) <span id="valS0C">1000</span> Million $</label>
            <input type="range" id="S0C" min="100" max="5000" step="100" value="1000">
            <div class="slider-hint">Initial premium in Million $ | Min: $100M | Max: $5000M</div>
        </div>
    </div>

    <!-- STRATEGIES -->
    <div class="card">
        <h2>üé≤ Players' Retention Strategies</h2>

        <blockquote>
            "In game theory, strategy is choice under uncertainty." ‚Äî J. Nash
        </blockquote>

        <p style="color: #94a3b8; margin-bottom: 20px;">
            <strong>Retention Rate:</strong> Percentage of premium and claims kept by the insurer (0 = cede all, 1 = keep all)
        </p>

        <div class="slider-group">
            <label>Player A Retention Rate <span id="valA">0.20</span></label>
            <input type="range" id="qA" min="0" max="1" step="0.01" value="0.2">
            <div class="slider-hint">0 = cede all risk | 0.5 = retain 50% | 1.0 = retain all risk</div>
        </div>

        <div class="slider-group">
            <label>Player B Retention Rate <span id="valB">0.20</span></label>
            <input type="range" id="qB" min="0" max="1" step="0.01" value="0.2">
            <div class="slider-hint">0 = cede all risk | 0.5 = retain 50% | 1.0 = retain all risk</div>
        </div>

        <div class="slider-group">
            <label>Player C Retention Rate <span id="valC">0.20</span></label>
            <input type="range" id="qC" min="0" max="1" step="0.01" value="0.2">
            <div class="slider-hint">0 = cede all risk | 0.5 = retain 50% | 1.0 = retain all risk</div>
        </div>

        <div class="slider-group">
            <label>Scenario:
                <select id="scenario">
                    <option value="classic">Classic Reinsurance</option>
                    <option value="nash">Nash Equilibrium</option>
                </select>
            </label>
            <div class="slider-hint">Classic: use your retention rates | Nash: find optimal distribution</div>
        </div>

        <button id="runBtn" onclick="runSimulation()">Run Simulation</button>
        <div id="errorMsg"></div>
    </div>

    <!-- RESULTS -->
    <div class="card">
        <h2>üìä Expected Payoffs (Million Dollars)</h2>

        <blockquote>
            "Risk cannot be eliminated, only redistributed."
        </blockquote>

        <p style="color: #cbd5f5; margin-bottom: 20px;">
            <strong>Results in Million Dollars:</strong> Profit values below are in Million $
        </p>

        <div class="results">
            <div class="result-box">
                Player A Profit<br><span id="pA">‚Äî</span> Million $
                <small id="pA_info"></small>
            </div>
            <div class="result-box">
                Player B Profit<br><span id="pB">‚Äî</span> Million $
                <small id="pB_info"></small>
            </div>
            <div class="result-box">
                Player C Profit<br><span id="pC">‚Äî</span> Million $
                <small id="pC_info"></small>
            </div>
        </div>

        <p id="nash" style="margin-top:20px;color:#a5f3fc;"></p>
    </div>

    <!-- COMPARISON CLASSIC vs NASH -->
    <div class="card">
        <h2>‚öñÔ∏è Comparison: Classic vs Nash (Million Dollars)</h2>

        <blockquote>
            "The Nash equilibrium reveals how strategic thinking transforms risk allocation."
        </blockquote>

        <p style="color: #cbd5f5; margin-bottom: 20px;">
            <strong>Comparison in Million Dollars:</strong> See how Nash equilibrium optimizes profit distribution
        </p>

        <div class="results">
            <div class="result-box">
                Player A (Million $)<br>
                Classic: <span id="compA_classic">‚Äî</span><br>
                Nash: <span id="compA_nash">‚Äî</span>
            </div>
            <div class="result-box">
                Player B (Million $)<br>
                Classic: <span id="compB_classic">‚Äî</span><br>
                Nash: <span id="compB_nash">‚Äî</span>
            </div>
            <div class="result-box">
                Player C (Million $)<br>
                Classic: <span id="compC_classic">‚Äî</span><br>
                Nash: <span id="compC_nash">‚Äî</span>
            </div>
        </div>

        <p id="diff" style="margin-top:15px;color:#a5f3fc;"></p>
    </div>

    <!-- STOCHASTIC DYNAMICS -->
    <div class="card">
        <h2>üå´Ô∏è Stochastic Dynamics</h2>

        <blockquote>
            "The Brownian path shows the random walk of claims over time."
        </blockquote>

        <div id="plot" style="height:300px;"></div>
    </div>

    <footer>
        NashShield ¬© Stochastic Modeling & Game Theory
    </footer>
</div>

<script>
// Update slider values display
['qA','qB','qC'].forEach(id => {
    document.getElementById(id).oninput = e => {
        document.getElementById('val' + id[1]).innerText = parseFloat(e.target.value).toFixed(2);
    }
});

// Update claim sliders
['S0A','S0B','S0C'].forEach(id => {
    document.getElementById(id).oninput = e => {
        document.getElementById('val' + id).innerText = parseInt(e.target.value);
    }
});

// Main simulation function
async function runSimulation() {
    const qA = parseFloat(document.getElementById('qA').value);
    const qB = parseFloat(document.getElementById('qB').value);
    const qC = parseFloat(document.getElementById('qC').value);
    const S0A = parseInt(document.getElementById('S0A').value);
    const S0B = parseInt(document.getElementById('S0B').value);
    const S0C = parseInt(document.getElementById('S0C').value);
    const scenario = document.getElementById('scenario').value;

    const errorMsg = document.getElementById('errorMsg');
    const runBtn = document.getElementById('runBtn');

    // Clear previous errors
    errorMsg.innerHTML = '';
    console.log('Run Simulation clicked with:', {qA, qB, qC, S0A, S0B, S0C, scenario});

    // Validate quota constraint
    if (qA + qB + qC > 1) {
        const msg = '‚ö†Ô∏è Error: Sum of quotas must be ‚â§ 1. Current sum: ' + (qA + qB + qC).toFixed(2);
        errorMsg.innerHTML = '<div class="error">' + msg + '</div>';
        console.error(msg);
        return;
    }

    // Disable button during simulation
    runBtn.disabled = true;
    runBtn.innerText = 'Running...';

    try {
        console.log('Sending request to /simulate');
        // First get results for current scenario
        const response = await fetch('/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({qA, qB, qC, S0A, S0B, S0C, scenario})
        });
        
        console.log('Response status:', response.status);
        const currentData = await response.json();
        console.log('Current data:', currentData);

        if (currentData.error) {
            errorMsg.innerHTML = '<div class="error">‚ö†Ô∏è Backend error: ' + currentData.error + '</div>';
            console.error('Backend error:', currentData.error);
            return;
        }

        // Get classic scenario data
        const classicResponse = await fetch('/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({qA, qB, qC, S0A, S0B, S0C, scenario: 'classic'})
        });
        const classicData = await classicResponse.json();
        console.log('Classic data:', classicData);

        // Get nash scenario data
        const nashResponse = await fetch('/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({qA, qB, qC, S0A, S0B, S0C, scenario: 'nash'})
        });
        const nashData = await nashResponse.json();
        console.log('Nash data:', nashData);

        // Update main results
        document.getElementById('pA').innerText = currentData.profit_A.toFixed(2);
        document.getElementById('pB').innerText = currentData.profit_B.toFixed(2);
        document.getElementById('pC').innerText = currentData.profit_C.toFixed(2);

        document.getElementById('pA_info').innerText = 'Retention: ' + qA.toFixed(2);
        document.getElementById('pB_info').innerText = 'Retention: ' + qB.toFixed(2);
        document.getElementById('pC_info').innerText = 'Retention: ' + qC.toFixed(2);

        document.getElementById('nash').innerText = 
            scenario === 'nash' 
                ? "‚öñÔ∏è Nash equilibrium applied - optimized risk distribution." 
                : "üìä Classic scenario - using your specified retention rates.";

        // Update comparison card
        document.getElementById('compA_classic').innerText = classicData.profit_A.toFixed(2);
        document.getElementById('compB_classic').innerText = classicData.profit_B.toFixed(2);
        document.getElementById('compC_classic').innerText = classicData.profit_C.toFixed(2);

        document.getElementById('compA_nash').innerText = nashData.profit_A.toFixed(2);
        document.getElementById('compB_nash').innerText = nashData.profit_B.toFixed(2);
        document.getElementById('compC_nash').innerText = nashData.profit_C.toFixed(2);

        // Calculate differences
        const diffA = (nashData.profit_A - classicData.profit_A).toFixed(2);
        const diffB = (nashData.profit_B - classicData.profit_B).toFixed(2);
        const diffC = (nashData.profit_C - classicData.profit_C).toFixed(2);

        document.getElementById('diff').innerHTML =
            `<strong>Œî (Nash - Classic):</strong> Player A: ${diffA > 0 ? '+' : ''}${diffA}, ` +
            `Player B: ${diffB > 0 ? '+' : ''}${diffB}, ` +
            `Player C: ${diffC > 0 ? '+' : ''}${diffC}`;

        // Plot Brownian motion
        plotBrownian();
        
        console.log('Simulation completed successfully');

    } catch (error) {
        const msg = '‚ö†Ô∏è Connection error: ' + error.message;
        errorMsg.innerHTML = '<div class="error">' + msg + '</div>';
        console.error('Error:', error);
    } finally {
        runBtn.disabled = false;
        runBtn.innerText = 'Run Simulation';
    }
}
    


// Plot Brownian motion
function plotBrownian() {
    let x = [0], y = [0];
    for (let i = 1; i < 200; i++) {
        x.push(i);
        y.push(y[i-1] + (Math.random() - 0.5));
    }

    Plotly.newPlot('plot', [{
        x: x,
        y: y,
        mode: 'lines',
        line: {
            color: '#38bdf8',
            width: 2
        }
    }], {
        margin: {t: 10, l: 40, r: 10, b: 40},
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: '#e5e7eb'},
        xaxis: {
            title: 'Time Steps',
            gridcolor: 'rgba(255,255,255,0.1)'
        },
        yaxis: {
            title: 'Random Walk',
            gridcolor: 'rgba(255,255,255,0.1)'
        }
    });
}

// Particles animation (pollen-like diffusion)
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");
let w, h, particles = [];

function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
}
window.onresize = resize;
resize();

for (let i = 0; i < 120; i++) {
    particles.push({
        x: Math.random() * w,
        y: Math.random() * h,
        r: Math.random() * 2 + 1,
        dx: (Math.random() - 0.5) * 0.5,
        dy: (Math.random() - 0.5) * 0.5
    });
}

function animate() {
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "rgba(255,255,255,0.5)";
    particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
        p.x += p.dx;
        p.y += p.dy;
        if (p.x < 0 || p.x > w || p.y < 0 || p.y > h) {
            p.x = Math.random() * w;
            p.y = Math.random() * h;
        }
    });
    requestAnimationFrame(animate);
}
animate();

// Initial plot on load (optional)
plotBrownian();

// Navigation function
function goToWelcome() {
    window.location.href = '/welcome';
}
</script>

</body>
</html>